!function(e){"use strict";var a,t,n,r,l,o,d,i,s,c=$("#form-body"),p=$("#data-body"),u=Math.random().toString().replace(/^0\./,"&&");s=new RegExp("[^A-Za-z0-9]+","i"),t=function(e,a,t){var n="http://db.kinomecore.com/2.0.0/"+e;return fetch(n,{method:a,mode:"cors",cache:"no-cache",credentials:"include",headers:{"Content-Type":"application/json"},redirect:"follow",referrer:"no-referrer",body:JSON.stringify(t)}).then(function(e){return e.json()})},l=function(){var e,n,r,l,o,d,i;return o=function(e){var a=new Date(e.replace(/[^\d\/]+/g,"").replace(/\/+/g,"/").replace(/^10\/210\/09$/,"10/21/09").replace(/8\/24\/812/,"8/24/12"));return isNaN(a.getDate())&&console.warn("bad dateStr",e),a},function(){var e,a,t,r,l=Math.random().toString().replace(/^0\./,"");n={},$("#page-body").append($('<div class="modal fade" id="modal'+l+'" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="title'+l+'"></h5><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body" id="body'+l+'"></div><div class="modal-footer" id="foot'+l+'"></div></div></div></div>')),r=$("#modal"+l),e=$("#title"+l),a=$("#body"+l),t=$("#foot"+l),n.title=function(a){e.empty(),e.append(a)},n.body=function(e){a.empty(),a.append(e)},n.foot=function(e){t.empty(),t.append(e)},n.open=function(){r.modal("show")},n.close=function(){r.modal("hide")}}(),d=function(e){return function(a,t){return e[a].date-e[t].date}},r=function(e){var r={};return n.title(e.pdx_id+": "+e.entry_name),n.body(a(e,!0,"Edit - Submit changes at bottom.",!0,function(e,a){var t=a.split(u);r[t[0]]=r[t[0]]||{},r[t[0]][t[1]]=e})),n.foot($("<button>",{class:"btn btn-primary",text:"Submit Changes",click:function(e){var a=Object.keys(r);e.preventDefault(),Promise.all(a.map(function(e){var a;return console.log(r[e]),a=t("/passages/passages/"+e,"PATCH",r[e]),delete r[e],a})).then(function(e){console.log("response to submit",e),e.map(function(e){return e}),n.close()})}})),n.open(),e},e=function(e){return $("<div>",{class:"text-center"}).append($("<button>",{class:"btn btn-primary",text:"Edit entry",click:function(e){return function(a){a.preventDefault(),r(e)}}(e)}))},i=function(t,n,r){return function(){var l,o,d,i,s="";for(o=$("<div>",{class:"col-md-4 col-sm-12",style:"border: 2px solid grey;border-radius: 5px;max-height: 200px;overflow-y:scroll;overflow: -moz-scrollbars-vertical;"}).append($("<h4>",{text:"Prior",class:"text-center"})),i=$("<div>",{class:"col-md-4 col-sm-12",style:"border: 2px solid grey;border-radius: 5px;max-height: 200px;overflow-y:scroll;overflow: -moz-scrollbars-vertical;"}).append($("<h4>",{text:"Current",class:"text-center"})),d=$("<div>",{class:"col-md-4 col-sm-12",style:"border: 2px solid grey;border-radius: 5px;max-height: 200px;overflow-y:scroll;overflow: -moz-scrollbars-vertical;"}).append($("<h4>",{text:"Next",class:"text-center"})),l=0;l<n[t].old.length;l+=1)n[t].old[l].self?o.append(a(n[t].old[l].self,!0,"Circle "+n[t].old[l].order)):o.append(a({entry_data:[{key:"New Exp#",value:n[t].old[l].id}]},!0,"Circle "+n[t].old[l].order));for(n[t].self?(i.append(e(n[t].self)),i.append(a(n[t].self,!0,"Circle "+n[t].order))):i.append(a({entry_data:[{key:"New Exp#",value:t}]},!0,"Circle "+n[t].order)),l=0;l<n[t].next.length;l+=1)n[t].next[l].self?d.append(a(n[t].next[l].self,!0,"Circle "+n[t].next[l].order)):d.append(a({entry_data:[{key:"New Exp#",value:n[t].next[l].id}]},!0,"Circle "+n[t].next[l].order));s=s.replace(/,$/,""),r.empty().append(o).append(i).append(d)}},l=function(e,a){var t,n,r,l,s,c,p,u,f,m,h=new Set,y={};for(t=0;t<e.length;t+=1){for(f=0,m=0,p=0,n=0;n<e[t].entry_data.length;n+=1)e[t].entry_data[n].key.match(/new\sexp/i)?f=e[t].entry_data[n].value:e[t].entry_data[n].key.match(/old\sexp/i)?m=e[t].entry_data[n].value:e[t].entry_data[n].key.match(/Passage\sDate/i)&&(p=o(e[t].entry_data[n].value));f||(f=":undefined: "+Math.random().toString().replace(/0\./,"")),m||(m=":undefined: "+Math.random().toString().replace(/0\./,"")),m.match(/-|none/)||(m=m.replace(/^X(\d{2})(\d+)$/,"X$1-$2")),f.match(/-/)||(f=f.replace(/^X(\d{2})(\d+)$/,"X$1-$2")),f=f.replace(/[^\w\d\-\*\:]+/gi,""),(m=m.replace(/[^\w\d\-\*\:]+/gi,""))===(f=(f="X"+f).replace(/X+/gi,"X"))&&(f=m+"&&dup1"),y[f]=y[f]||{self:[],date:[],id:f,old:[],next:[]},y[f].self.push(e[t]),y[f].date.push(p),m.match(/none/i)||(m=(m="X"+m).replace(/X+/gi,"X"),y[m]=y[m]||{self:[],date:[],id:m,old:[],next:[]},y[m].next.push(y[f]),y[f].old.push(y[m]))}u=Object.keys(y);var v,_;for(t=0;t<u.length;t+=1)if(y[u[t]].self.length>1){for(v=y[u[t]],_=[],delete y[u[t]],n=0;n<v.self.length;n+=1)_.push(u[t]+"&&dup"+n),y[u[t]+"&&dup"+n]={self:[v.self[n]],date:[v.date[n]],id:f,old:v.old,next:v.next};for(n=0;n<v.old.length;n+=1){for(r=0;r<v.old[n].next.length;r+=1)v.old[n].next[r].self.length>1&&v.old[n].next.splice(r,1);for(r=0;r<_.length;r+=1)v.old[n].next.push(y[_[r]])}}u=Object.keys(y);var g=new Date;for(t=0;t<u.length;t+=1)y[u[t]].self=y[u[t]].self[0],y[u[t]].date=y[u[t]].date[0],y[u[t]].date&&(g=Math.min(g,y[u[t]].date));for(t=0;t<u.length;t+=1)y[u[t]].date?y[u[t]].type="fixed":(y[u[t]].type="free",y[u[t]].date=new Date(g));for(t=0;t<u.length;t+=1)if(1!==y[u[t]].old.length&&h.add(u[t]),y[u[t]].next.length>1)for(n=0;n<y[u[t]].next.length;n+=1)h.add(y[u[t]].next[n].id);for(s=DATA_DISPLAY.generateColor(h.size+1),t=0,h.forEach(function(e){for(y[e].nodeColor=s[t],l=y[e].next;1===l.length;)l[0].nodeColor=s[t],l=l[0].next;t+=1}),u=u.sort(d(y)),t=0;t<u.length;t+=1)y[u[t]].order=t;for(c={nodes:[],links:[]},t=0;t<u.length;t+=1)for(c.nodes.push({name:y[u[t]].id,date:new Date(y[u[t]].date.getFullYear(),y[u[t]].date.getMonth()).toGMTString(),id:y[u[t]].order,from:y[u[t]].nodeColor,type:y[u[t]].type,click:i(u[t],y,a)}),n=0;n<y[u[t]].next.length;n+=1)c.links.push({source:y[u[t]].order,target:y[u[t]].next[n].order,type:"answeredby",color:y[u[t]].next[n].nodeColor});return c},function(e,a){var t,n,r,o,d={};for(t=0;t<e.length;t+=1)d[e[t].pdx_id]=d[e[t].pdx_id]||{},d[e[t].pdx_id][e[t].entry_name]=d[e[t].pdx_id][e[t].entry_name]||[],d[e[t].pdx_id][e[t].entry_name].push(e[t]);n=Object.keys(d);var i,s;for(t=0;t<n.length;t+=1)d[n[t]].hasOwnProperty("PDX Passage Info")&&(s=Math.random().toString().replace(/^0\./,""),(i=$("<div>",{class:"row"}).appendTo(a)).append($("<h4>Passage Information Timeline</h4>")),i.append($("<div>",{id:"timelinefig"+s,class:"text-center chart"})),(o=$("<div>",{class:"row"})).appendTo(a),r=l(d[n[t]]["PDX Passage Info"],o),loadchart("timelinefig"+s,r))}}(),n=function(){var e;return e=function(e){var a=0,t={summary:[],data_availiable:[]};for(a=0;a<e.length;a+=1)"Summary Table"===e[a].entry_name?t.summary.push(e[a]):"PDX_ID to old PDX_ID_OldKinomic/Affy/Illumina ID's"!==e[a].entry_name&&"PDX_ID to Nanostring naming and model information"!==e[a].entry_name||t.data_availiable.push(e[a]);return t},function(a,t){var n,r,l,o,d,i,s,c,p,u,f,m,h;if(n=e(a),r=$("<div>",{class:"row"}).appendTo(t),n.data_availiable.length)for($("<div>",{class:"col-12 h4",text:"Avaliable Data"}).appendTo(r),r=$("<dl>",{class:"row"}).appendTo($("<div>",{class:"col-12"}).appendTo(r)),l=0;l<n.data_availiable.length;l+=1){if(n.data_availiable[l].entry_name.match(/NanoString/i)){for(o=0;o<n.data_availiable[l].entry_data.length;o+=1)n.data_availiable[l].entry_data[o].key.match(/Nsname_model/)?c=n.data_availiable[l].entry_data[o].value:n.data_availiable[l].entry_data[o].key.match(/Model/)?d=n.data_availiable[l].entry_data[o].value:n.data_availiable[l].entry_data[o].key.match(/Comment/)?i=n.data_availiable[l].entry_data[o].value:n.data_availiable[l].entry_data[o].key.match(/Class\ Name/)&&(s=n.data_availiable[l].entry_data[o].value);d=d.charAt(0).toUpperCase()+d.slice(1),$('<dt class="col-sm-3">NanoString</dt> <dd class="col-sm-9">'+d+" ("+i+"): "+c+" ("+s+")</dd>").appendTo(r)}if(n.data_availiable[l].entry_name.match(/PDX_ID_OldKinomic/i)){for(u="",f="",m="",h="",o=0;o<n.data_availiable[l].entry_data.length;o+=1)n.data_availiable[l].entry_data[o].key.match(/Kinomics_Sample/)?u=n.data_availiable[l].entry_data[o].value:n.data_availiable[l].entry_data[o].key.match(/Affy_Sample\ ID/)?f=n.data_availiable[l].entry_data[o].value:n.data_availiable[l].entry_data[o].key.match(/Illumina_ID/)?m=n.data_availiable[l].entry_data[o].value:n.data_availiable[l].entry_data[o].key.match(/Illumina_SentrixPosition/)&&(h=n.data_availiable[l].entry_data[o].value);u.length&&(p="http://toolbox.kinomecore.com/?data="+encodeURIComponent('*[http://db.kinomecore.com/1.0.0/lvl_1.1.2?find={"sample_data":{"$elemMatch":{"value":"'+u+'"}}}]*'),$('<dt class="col-sm-3">Kinomics</dt><dd class="col-sm-9"><a href="'+p+'">'+u+"</a></dd>").appendTo(r)),f.length&&$('<dt class="col-sm-3">Affymetrix:</dt> <dd class="col-sm-9">'+f+"</dd>").appendTo(r),m.length&&$('<dt class="col-sm-3">Illumina:</dt> <dd class="col-sm-9">'+m+" (pos: "+h+")</dd>").appendTo(r)}}return console.log("summary information",n),t}}(),i=function(){var e,t,r,o,d,i,s,c;return c=function(e){var a,t={};for(a=0;a<e.length;a+=1)t[e[a].pdx_id]=t[e[a].pdx_id]||[],t[e[a].pdx_id].push(e[a]);return{ids:Object.keys(t),data:t}},e=function(e,a){var t,r,d,i;for(console.log("Data Selected",a),p.empty(),p.append($("<p>",{class:"h2 row",text:e})),r=c(a),d=0;d<r.ids.length;d+=1)i=r.data[r.ids[d]],p.append($("<p>",{class:"h3 row",text:"PDX ID: "+r.ids[d]})),t=$("<div>",{class:"row"}),p.append(t),t=$("<div>",{class:"col-12"}).appendTo(t),n(i,t),t=$("<div>",{class:"row"}),p.append(t),t=$("<div>",{class:"col-12"}).appendTo(t),l(i,t),p.append($("<p>",{class:"h4 row",text:"All Descriptive Data"})),p.append(o(i))},i=function(e,a,t){var n=t>1?" entries)":" entry)";return $("<div>",{class:"card-header",id:"heading"+a}).append($("<h2>",{class:"mb-0"}).append($("<button>",{class:"btn btn-link collapsed",type:"button","data-toggle":"collapse","data-target":"#collapse"+a,"aria-expanded":"false","aria-controls":"collapse"+a,html:e+" ("+t+n})))},s=function(e,t){var n,r,l;for(n=$("<div>",{id:"collapse"+t,class:"collapse","aria-labelledby":"headingOne","data-parent":"#accordionHolder"}),r=$("<div>",{class:"card-body"}),l=0;l<e.length;l+=1)r.append(a(e[l]));return n.append(r),n},a=function(e,a,t,n,r){var l,o,d,i,s,c,p="";for(c=function(e,a){return function(t){return e(t.target.value,a)}},e.pdx_id=e.pdx_id||"N/A",e.entry_name=e.entry_name||"N/A",e.description=e.description||"N/A",e.entry_metadata=e.entry_metadata||{},e.entry_metadata.user=e.entry_metadata.user||"N/A",e.entry_data=e.entry_data||[],p+='<p class="h5">'+e.pdx_id+": "+e.entry_name+'</p><p class="font-weight-light text-muted">'+e.description+"<br />-"+e.entry_metadata.user+"</p><hr />",a&&(p='<p><ul class="list-group"><p class="lead">'+e.pdx_id+": "+t+"</p></ul></p><hr />"),s=$("<div>").append($(p)),d=$("<ul>",{class:"list-group"}).appendTo(s),l=0;l<e.entry_data.length;l+=1)i=$("<li>",{class:"list-group-item"}),n?(o=e._id+u+"entry_data."+l+".value",i.append($("<div>",{class:"form-group row"}).append($("<label>",{text:e.entry_data[l].key,for:o,class:"col-sm-3 col-form-label"})).append($("<div>",{class:"col-sm-9"}).append($("<input>",{class:"form-control",id:o,value:e.entry_data[l].value}).on("keyup",c(r,o)))))):i.append($("<strong>",{html:e.entry_data[l].key})).append($("<span>&emsp;"+e.entry_data[l].value+"</span>")),d.append(i);return s},o=function(e){var a,n,r,l,o,d;for(n=t(e),a=Object.keys(n),d=$("<div>",{class:"row"}),l=$("<div>",{class:"accordion",style:"margin-bottom: 10px;",id:"accordionHolder"}).appendTo(d),r=0;r<a.length;r+=1)o=Math.random().toString().replace(/^0\./,""),l.append($("<div>",{class:"card"}).append(i(a[r],o,n[a[r]].length)).append(s(n[a[r]],o)));return d},d=function(e,a){return r(a)-r(e)},r=function(e){var a,t,n=-1/0;for(a=0;a<e.entry_data.length;a+=1)e.entry_data[a].value.match(/\d{1,2}\/\d{1,2}\/\d{1,2}/)&&(t=Date.parse(e.entry_data[a].value))&&(n=Math.max(t,n));return n},t=function(e){var a=0,t={},n=[];for(a=0;a<e.length;a+=1)t[e[a].entry_name]=t[e[a].entry_name]||[],t[e[a].entry_name].push(e[a]),n.push(e[a].entry_name);for(a=0;a<n.length;a+=1)t[n[a]]=t[n[a]].sort(d);return t},e}(),r=function(){var e,a,t;return a=function(e,a){return!(!e||""===e)&&t.indexOf(e)===a},e=function(e){var a,t=[];for(a=0;a<e.length;a+=1)t=(t=t.concat(e[a].key.split(s))).concat(e[a].value.split(s));return t},function(n){var r,l,o,d,i={};for(d=["description","entry_data","entry_metadata","entry_name","historical","origin_id","pdx_id"],r=0;r<n.length;r+=1)for(t=[],Object.defineProperty(n[r],"search_temp_key",{value:Math.random().toString().replace(/0\./,""),writable:!1,enumerable:!1,configurable:!1}),t=t.concat(n[r][d[0]].split(s)),t=t.concat(n[r][d[3]].split(s)),t=t.concat([n[r][d[4]]]),t=t.concat([n[r][d[5]]]),t=t.concat(n[r][d[4]].split(s)),t=t.concat(n[r][d[5]].split(s)),t=t.concat(e(n[r][d[1]])),t=t.concat(e(n[r][d[2]])),t=t.filter(a),l=0;l<t.length;l+=1)i[o=t[l].toLocaleLowerCase()]=i[o]||[],i[o].push(n[r]);return i}}(),o=function(e){var a,t,n,l,o,p,u,f,m,h,y,v,_,g=d(e),b=Object.keys(g),x=r(e),k=!1;for(n=[],o=function(){k||(k=!0,setTimeout(f,1e3))},f=function(){k?(k=!1,setTimeout(f,1e3)):u(p.val())},y=function(e,a){var t,n;return t=1*e.replace(/[^0-9]+/gi,""),n=1*a.replace(/[^0-9]+/gi,""),t&&n&&t>2&&n>2&&t-n!=0?t-n:e>a?1:a>e?-1:0},u=function(e){var a,t,n,r,l=[],o={},d=0;for(m(),a=e.toLocaleLowerCase().split(s),t=0;t<a.length;t+=1)if(x.hasOwnProperty(a[t]))for(n=0;n<x[a[t]].length;n+=1)l.push(x[a[t]][n]),o[x[a[t]][n].search_temp_key]=o[x[a[t]][n].search_temp_key]||[{},x[a[t]][n]],o[x[a[t]][n].search_temp_key][0][a[t]]=1,d=Math.max(Object.keys(o[x[a[t]][n].search_temp_key][0]).length,d);if(d>1)for(l=[],r=Object.keys(o),t=0;t<r.length;t+=1)Object.keys(o[r[t]][0]).length>=d&&l.push(o[r[t]][1]);i("Search: '"+e+"'",l)},m=function(){var e;for(e=0;e<n.length;e+=1)n[e].select[0][0].selected=!0},h=function(){p.val("")},l=function(e){var a,t;for(e.preventDefault(),h(),a=this.value.split(";").map(function(e){return 1*e}),t=0;t<n.length;t+=1)t!==a[0]&&(n[t].select[0][0].selected=!0);i(b[a[0]]+": "+n[a[0]].option_keys[a[1]],g[b[a[0]]][n[a[0]].option_keys[a[1]]])},v=0;v<b.length;v+=1){for(t=$("<select>",{class:"form-control",id:"select headers"+v}),c.append($("<div>",{class:"form-group col-3"}).append($("<label>",{for:"select headers"+v,text:b[v]})).append(t)),a=Object.keys(g[b[v]]).sort(y),$("<option>",{text:"Select one...",disabled:"disabled",selected:"selected"}).appendTo(t),n[v]={select:t,option_keys:JSON.parse(JSON.stringify(a)),options:[]},_=0;_<a.length;_+=1)n[v].options[_]=$("<option>",{text:a[_],val:v+";"+_}).appendTo(t);t.on("change",l)}p=$("<input>",{type:"text",style:"height: 100%",class:"form-control","aria-label":"Default","aria-describedby":"searchBarInuput439201432"}).on("keyup",o),$("<div>",{class:"input-group mb-3 col-6"}).append($("<div>",{class:"input-group-prepend"}).append($("<span>",{class:"input-group-text",id:"searchBarInuput439201432",html:"Exact Word Search"}))).append(p).appendTo(c)},d=function(e){var a,t={pdx_id:{},origin_id:{}},n=Object.keys(t);return e.map(function(e){for(a=0;a<n.length;a+=1)e.hasOwnProperty(n[a])&&(t[n[a]]=t[n[a]]||{},t[n[a]][e[n[a]]]=t[n[a]][e[n[a]]]||[],t[n[a]][e[n[a]]].push(e))}),t},e.build_page=o}(DATA_DISPLAY);