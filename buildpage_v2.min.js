!function(e){"use strict";const t=$("#form-body"),a=$("#data-body"),n=$("#page-alerts"),l={passages:["Passage Date","Passage#","Old Exp#","New Exp#","# of Fixed Tissues","# of OCT Cassettes","# of Snap-Frozen Vials","# of Cultured Flasks","# of Cryo-Frozen Vials"]};let i,o,d;const s=function(){return Math.random().toString().replace(/0\./,"")},c=function(e){$('<div class="alert alert-danger alert-dismissible fade show" role="alert"><strong>Error: </strong> '+e.message+'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>').appendTo(n),console.error(e)},r=function(e){return new Promise(function(t){setTimeout(t,e)})},p=function(e,t,a){let n={};return function(l){a||(a="Don't call this twice without a uniqueId",console.warn(a)),n[a]&&clearTimeout(n[a]),n[a]=setTimeout(()=>e(l),t)}},u=function(e){let t,a,n;e.row?(n="form-group row",a="col-form-label col-sm-"+e.width,t=$("<div>",{class:"col-sm-"+(12-e.width)})):(n="from-group col-"+e.width,a="",t=$("<div>"));const l=s();let i=$("<div>",{class:n}).append($("<label>",{for:"select-header-"+l,text:e.label,class:a})),o=$("<select>",{class:"form-control",id:"select-header-"+l}).appendTo(t),d=$("<option>",{disabled:"disabled",selected:"selected",text:"Select One"});return o.append(d),e.data.forEach(function(t){o.append($("<option>",{value:JSON.stringify({key:e.key,value:t.label}),text:t.label,disabled:t.disabled||!1}))}),e.row?i.append(t):i.append(o),o.change(function(t){t.preventDefault(),e.change(JSON.parse(t.target.value))}),i},f=function(e){const t=s();return $("<div>",{class:"form-group row"}).append($("<label>",{text:e.label,for:"list-item-"+t,class:"col-sm-3 col-form-label"})).append($("<div>",{class:"col-sm-9"}).append($("<input>",{class:"form-control",id:"list-item-"+t,disabled:e.disabled||!1,value:e.value}).on("keyup",p(function(t){e.func({id:e.id,key:e.key,value:t.target.value,origin:e.value})},500,e.rand_wait))))},m=function(e){const t=s();return e=e||{},e.edit=e.edit||!1,e.edit_func=e.edit_func||console.log,e.short=e.short||!1,e.short_title=e.short_title||"",e.special_list=e.special_list||[],e.special_list=e.special_list.map(function(e){return{label:e}}),function(a){e.edit&&(a.entry_name.match(/^PDX\ Passage\ Info$/)&&!i.passages.write&&(e.edit=!1),a.entry_name.match(/^PDX\ Passage\ Info$/)||i.other.write||(e.edit=!1)),a.pdx_id=a.pdx_id||"N/A",a.entry_name=a.entry_name||"N/A",a.description=a.description||"N/A",a.entry_metadata=a.entry_metadata||{},a.entry_metadata.user=a.entry_metadata.user||"N/A",a.entry_data=a.entry_data||[];const n=$("<div>"),l=$("<ul>",{class:"list-group"});if(e.short?n.append($("<p>",{class:"lead",text:a.pdx_id+": "+e.short_title})):(n.append($("<p>",{class:"h5",text:a.pdx_id+": "+a.entry_name})),n.append($("<p>",{class:"font-weight-light text-muted",html:a.description+"<br />-"+a.entry_metadata.user}))),l.appendTo(n),a.entry_data.forEach(function(n,i){const o=$("<li>",{class:"list-group-item"});e.edit?o.append(f({label:n.key,value:n.value,func:e.edit_func,id:a._id,key:"entry_data."+i,rand_wait:t})):o.append($("<strong>",{html:n.key})).append($("<span>&emsp;"+n.value+"</span>")),e.special_list.forEach(function(t,a){t.label===n.key&&(e.special_list[a].disabled=!0)}),l.append(o)}),e.edit){let n=$("<li>",{class:"list-group-item"});l.append(n),n.append($("<button>",{class:"btn btn-primary",text:"Add Field",click:function(l){l.preventDefault();let i={},o=function(e,t){return i[e]=t,i},d=$("<li>",{class:"list-group-item"}),s=$("<div>",{class:"col-12",style:"margin-top: 10px;"});e.special_list.push({label:"Other"}),d.append(u({width:12,label:"Key",data:e.special_list,key:"push:entry_data",change:function(n){s.empty(),"Other"===n.value?s.append(f({label:"New Key",value:"",func:function(t){t.value=o("key",t.value),e.edit_func(t)},id:a._id,key:"entry_data."+a.entry_data.length,rand_wait:t})).append(f({label:"New Value",value:"",func:function(t){t.value=o("value",t.value),e.edit_func(t)},id:a._id,key:"entry_data."+a.entry_data.length,rand_wait:t})):(o("key",n.value),s.append(f({label:n.value,value:"",func:function(t){t.value=o("value",t.value),e.edit_func(t)},id:a._id,key:"entry_data."+a.entry_data.length,rand_wait:t})))}})),d.append(s),n.replaceWith(d)}}))}return n}},y=function(e,t,a){const n=s(),l=$("<div>",{class:"card"});l.append(function(e,t,a){const n=a>1?" entries)":" entry)";return $("<div>",{class:"card-header",id:"header-"+t}).append($("<h2>",{class:"mb-0"}).append($("<button>",{class:"btn btn-link collapsed",type:"button","data-toggle":"collapse","data-target":"#collapse-"+t,"aria-expanded":"false","aria-controls":"collapse-"+t,html:e+" ("+a+n})))}(t,n,e.length));return function(e,t){let a,n;return a=$("<div>",{id:"collapse-"+e,class:"collapse","aria-labelledby":"headingOne","data-parent":"#accordionHolder"}),n=$("<div>",{class:"card-body"}).append(t),a.append(n),a}(n,e.map(function(e){return a.build(e,function(e){return m()(e)})})).appendTo(l),l},h=function(e){return m({short:!0,short_title:"Circle: "+e.circle})({pdx_id:e.name,entry_data:[{key:"*note",value:"This is a dummy node, it will only update after editing its child node and refreshing the timeline display."},{key:"New Exp#",value:e.name}]})};d=function(){const e=function(){let e,t,a,n,l=s(),i={};return $("#page-body").append($('<div class="modal fade" id="modal'+l+'" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="title'+l+'"></h5><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body" id="body'+l+'"></div><div class="modal-footer" id="foot'+l+'"></div></div></div></div>')),n=$("#modal"+l),e=$("#title"+l),t=$("#body"+l),a=$("#foot"+l),i.title=function(t){e.empty(),e.append(t)},i.body=function(e){t.empty(),t.append(e)},i.foot=function(e){a.empty(),a.append(e)},i.show=function(){n.modal("show")},i.hide=function(){n.modal("hide")},i}();return d=function(){return e},e};const b=function(t,n){let b;return b=function(v){t.clearUpdates(),a.empty();let _=function(){b(v)};const g=n(v),x=t.expandIDs(g);console.log("Selected IDS:",g),x.list("pdx_id").forEach(function(n){const b=x.expandIDs(x.filter(function(e){return e.pdx_id===n}));$("<p>",{class:"h3 row",text:"PDX ID: "+n}).appendTo(a);const v={nanostring:b.filter(e=>e.entry_name.match(/^PDX_ID\ to\ Nanostring\ naming\ and\ model\ information$/i)),omics:b.filter(e=>e.entry_name.match(/^PDX_ID\ to\ old\ PDX_ID_OldKinomic\/Affy\/Illumina\ ID\'s$/i)),passages:b.filter(e=>e.entry_name.match(/^PDX_ID\ to\ old\ PDX_ID_OldKinomic\/Affy\/Illumina\ ID\'s$/i))};(v.nanostring.length||v.omics.length)&&($("<p>",{class:"h4 row",text:"Avaliable Data"}).appendTo(a),function(e,t){const a=$("<p>",{class:"row"});return e.nanostring.forEach(function(e){t.build(e,function(e){let t={};return e.entry_data.forEach(function(e){t[e.key]=e.value}),$("<div>").append($("<dt>",{class:"col-sm-3",text:"NanoString"})).append($("<dd>",{class:"col-sm-9",text:t.Model+" ("+t["Comment 1"]+"): "+t.Nsname_model+" ("+t["Class Name"]+")"})).children()}).appendTo(a)}),e.omics.forEach(function(e){t.build(e,function(e){let t={};const a=$("<div>");return e.entry_data.forEach(function(e){t[e.key]=e.value}),a.append($("<dt>",{class:"col-sm-3",text:"Kinomics"})).append($("<dd>",{class:"col-sm-9",html:"<a href=http://toolbox.kinomecore.com/?data="+encodeURIComponent('*[http://db.kinomecore.com/1.0.0/lvl_1.1.2?find={"sample_data":{"$elemMatch":{"value":"'+t["Kinomics_Sample name ()"]+'"}}}]*')+">"+t["Kinomics_Sample name ()"]+"</a>"})),a.append($("<dt>",{class:"col-sm-3",text:"Affymetrix"})).append($("<dd>",{class:"col-sm-9",text:t["Affy_Sample ID"]})),a.append($("<dt>",{class:"col-sm-3",text:"Illumina"})).append($("<dd>",{class:"col-sm-9",html:t.Illumina_ID+"("+t.Illumina_SentrixPosition+")"})),a.children()}).appendTo(a)}),a}(v,t).appendTo(a));const g=b.filter(e=>e.entry_name.match(/^PDX\ Passage\ Info$/i));if(g.length){let n="figure-"+s();$("<p>",{class:"h4 row",text:"Passage Timeline"}).appendTo(a).append(t.build(g,function(e){let a=e[0];return $("<button>",{class:"btn btn-primary",style:"margin-left: 20px;",text:"Add Node",click:function(n){n.preventDefault(),function(e,t,a){let n,l=d(),i=s(),m=$("<div>");l.title("Create New Node");let y=JSON.parse(JSON.stringify(e));y.entry_metadata={user:o.replace(/@uab\.edu/,"")},y.entry_data={};let h=[];Object.keys(e).forEach(function(t){"string"==typeof e[t]?f({label:t,key:t,value:e[t],rand_wait:i,disabled:t.match(/^(pdx_id|origin_id|entry_name)$/),func:function(e){y[e.key]=e.value}}).appendTo(m):"object"==typeof e[t]&&Array.isArray(e[t])&&e[t].forEach(function(e){if("string"==typeof e.value)e.value&&(y.entry_data[e.key]=e.value),f({label:e.key,key:e.key,value:e.value,rand_wait:i,func:function(e){y.entry_data[e.key]=e.value}}).appendTo(m);else if("object"==typeof e.value&&Array.isArray(e.value)){let t=$("<div>",{class:"col-sm-9 offset-sm-3"});u({label:e.key,row:!0,width:3,data:e.value.map(e=>({label:e})),key:"entry_data."+e.key,change:function(e){return function(t){n.prop("disabled",!1),n.prop("style",""),e.empty(),"other"===t.value?e.append($("<input>",{class:"form-control",style:"margin-top: 10px;"}).on("keyup",p(function(e){y.entry_data["Old Exp#"]=e.target.value},500,i))):y.entry_data["Old Exp#"]=t.value}}(t)}).append(t).appendTo(m)}})});let b=$("<div>");$("<button>",{class:"btn btn-primary",text:"Other Field",click:function(e){let t={a:{}};h.push(t.a),e.preventDefault(),f({label:"Key",key:"",value:"",rand_wait:i,func:function(e){t.a.key=e.value}}).appendTo(b),f({label:"Value",key:"",value:"",rand_wait:i,func:function(e){t.a.value=e.value}}).appendTo(b)}}).appendTo(m),b.appendTo(m),n=$("<button>",{class:"btn-primary btn",text:"Submit",click:function(e){e.preventDefault(),y.entry_metadata.date=new Date,y.entry_data=Object.keys(y.entry_data).map(e=>({key:e,value:y.entry_data[e]})).concat(h),t.add(y,"passages","passages").then(r(500)).catch(c).then(function(){l.hide(),a()})},disabled:"disabled",type:"button",style:"pointer-events: none;"}),l.body(m),l.foot($("<span>",{class:"d-inline-block",tabindex:"0","data-toggle":"tooltip","data-placement":"left",title:"Old Exp # is required"}).append(n).tooltip()),l.show()}({pdx_id:a.pdx_id,origin_id:a.origin_id,model_environment:a.model_environment,historical:"no",description:a.description,entry_name:a.entry_name,entry_data:[{key:"Old Exp#",value:e.map(e=>e.entry_data).flat().filter(e=>"New Exp#"===e.key).map(e=>e.value).sort(function(e,t){return e=1*e.replace(/[^\d\-]/g,"").replace(/-/g,"."),t=1*t.replace(/[^\d\-]/g,"").replace(/-/g,"."),e-t}).concat(["none","other"])}].concat(l.passages.filter(e=>"Old Exp#"!==e).map(e=>({key:e,value:""})))},t,_)}})}));let y=$("<div>",{class:"col-12"}),b=$("<div>",{class:"col-12"}),v=$("<div>",{id:n,class:"chart"}),x={};b.append(v),$("<p>",{class:"row"}).append(b).append(y).appendTo(a),t.build(g,function(a){v.empty();let o=function(e,t,a){return function(n){a.name=n.name,t.hide(),t.empty();let o=$("<div>",{class:"row"}).appendTo(t),s=$("<div>",{class:"chart-data"}).appendTo($("<div>",{class:"col col-md-4 col-sm-12"}).appendTo(o)).append($("<p>",{class:"text-center h4",text:"Prior"})),p=$("<div>",{class:"chart-data col-md-4 col-sm-12"}).appendTo(o).append($("<p>",{class:"text-center h4",text:"Selected"})),u=$("<div>",{class:"chart-data"}).appendTo($("<div>",{class:"col col-md-4 col-sm-12"}).appendTo(o)).append($("<p>",{class:"text-center h4",text:"Next"}));n.prior.forEach(function(t){t.id?s.append(e.build(t.id,m({short:!0,short_title:"Circle: "+t.circle}))):s.append(h(t))}),n.self.forEach(function(t){if(t.id){if(i.passages.write){const a=$("<button>",{class:"btn btn-primary",text:"Update",click:function(a){a.preventDefault(),function(e,t){let a={},n={};const i=d();i.title($("<h4>",{text:"Edit Entry"})),i.body(t.build(e,m({edit:!0,edit_func:function(e){a[e.id]=a[e.id]||{},a[e.id][e.key]=e},special_list:l.passages}),n)),n.clear(),i.foot($("<button>",{class:"btn btn-primary",text:"Submit",click:function(e){e.preventDefault(),t.set(Object.keys(a).map(e=>Object.keys(a[e]).map(t=>a[e][t])).flat().filter(e=>e.value!==e.origin),"passages","passages").then(r(750)).catch(c).then(i.hide)}})),i.show()}(t.id,e)}});p.append($("<p>",{class:"text-center"}).append(a))}p.append(e.build(t.id,m({short:!0,short_title:"Circle: "+t.circle})))}else p.append(h(t))}),n.next.forEach(function(t){t.id?u.append(e.build(t.id,m({short:!0,short_title:"Circle: "+t.circle}))):u.append(h(t))}),t.show()}}(t,y,x);const s=e.createPassageFigure(a,o,x);return x.name&&(x.state&&x.state.name?o(x.state):y.hide()),loadchart(n,s.figure),v})}a.append($("<p>",{class:"h4 row",text:"All Descriptive Data"}));const k=$("<div>",{class:"accordion",id:"accordionHolder"}).appendTo($("<p>",{class:"row"}).appendTo(a));b.list("entry_name").forEach(function(e){y(b.filter(function(t){return t.entry_name===e}),e,t).appendTo(k)})})}};e.build_page=function(){const a=function(e,t){let a,n;return a=1*e.replace(/[^0-9]+/gi,""),n=1*t.replace(/[^0-9]+/gi,""),a&&n&&a>2&&n>2&&a-n!=0?a-n:e>t?1:t>e?-1:0},n=function(e){return function(t){const a=JSON.parse(t);return e.filter(function(e){return e&&e[a.key]&&e[a.key]===a.value})}},l=function(){let e={};return function(t){if(t=t.toString(),e[t])throw"Cannot call make_selectors with the same key multiple times";return e[t]={select:function(a){return e[t].select=function(n){Object.keys(e).forEach(function(a){a!==t&&e[a].unselect()}),a(n.target.value)},e[t].select},unselect:function(a){return e[t].unselect=a,e[t].unselect}},e[t]}}();return function(d,c){i=c,o=c.email;const r=e.expandData(d),u=[{data:r.list("pdx_id"),key:"pdx_id",label:"PDX ID",width:3,selector:l("0"),change:b(r,n(r))},{data:r.list("origin_id"),key:"origin_id",label:"Origin ID",width:3,selector:l("1"),change:b(r,n(r))}],f=$("<div>",{class:"row",id:"form-body"}).appendTo($("<div>",{class:"col-12"}).appendTo($("<div>",{class:"row"})).appendTo(t));return u.forEach(function(e){f.append(function(e){const t=s();let n=$("<div>",{class:"from-group col-"+e.width}).append($("<label>",{for:"select-header-"+t,text:e.label})),l=$("<select>",{class:"form-control",id:"select-header-"+t}),i=$("<option>",{disabled:"disabled",selected:"selected",text:"Select One"});return l.append(i),e.data.sort(a).forEach(function(t){l.append($("<option>",{value:JSON.stringify({key:e.key,value:t}),text:t}))}),n.append(l),l.change(e.selector.select(e.change)),e.selector.unselect(function(){i[0].selected=!0}),n}(e))}),function(e){const t=s(),a=e.selector.select(e.change);let n=$("<div>",{class:"form-group col-"+e.width}).append($("<label>",{for:"search-bar-"+t,text:e.label})),l=$("<input>",{class:"form-control",type:"text",id:"search-bar-"+t}),i="";return n.append(l),l.on("keyup",p(function(e){i!==e.target.value&&(a(e),i=e.target.value)},500,"search-"+t)),e.selector.unselect(function(){l.val("")}),n}({selector:l("2"),label:"Exact Word Search",width:6,change:b(r,function(e){return function(t){return e.search(t)}}(r))}).appendTo(f),u}}()}(DATA_DISPLAY);