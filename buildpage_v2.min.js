!function(e){"use strict";const t=$("#form-body"),a=$("#data-body"),n=$("#page-alerts"),l={passages:["Passage Date","Passage#","Old Exp#","New Exp#","# of Fixed Tissues","# of OCT Cassettes","# of Snap-Frozen Vials","# of Cultured Flasks","# of Cryo-Frozen Vials"]};let i,o;const s=function(){return Math.random().toString().replace(/0\./,"")},c=function(e){$('<div class="alert alert-danger alert-dismissible fade show" role="alert"><strong>Error: </strong> '+e.message+'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>').appendTo(n),console.error(e)},d=function(e,t,a){let n={};return function(l){a||(a="Don't call this twice without a uniqueId",console.warn(a)),n[a]&&clearTimeout(n[a]),n[a]=setTimeout(()=>e(l),t)}},r=function(e){const t=s();return $("<div>",{class:"form-group row"}).append($("<label>",{text:e.label,for:"list-item-"+t,class:"col-sm-3 col-form-label"})).append($("<div>",{class:"col-sm-9"}).append($("<input>",{class:"form-control",id:"list-item-"+t,value:e.value}).on("keyup",d(function(t){e.func({id:e.id,key:e.key,value:t.target.value,origin:e.value})},500,e.rand_wait))))},p=function(e){const t=s();return e=e||{},e.edit=e.edit||!1,e.edit_func=e.edit_func||console.log,e.short=e.short||!1,e.short_title=e.short_title||"",e.special_list=e.special_list||[],e.special_list=e.special_list.map(function(e){return{label:e}}),function(a){e.edit&&(a.entry_name.match(/^PDX\ Passage\ Info$/)&&!i.passages.write&&(e.edit=!1),a.entry_name.match(/^PDX\ Passage\ Info$/)||i.other.write||(e.edit=!1)),a.pdx_id=a.pdx_id||"N/A",a.entry_name=a.entry_name||"N/A",a.description=a.description||"N/A",a.entry_metadata=a.entry_metadata||{},a.entry_metadata.user=a.entry_metadata.user||"N/A",a.entry_data=a.entry_data||[];const n=$("<div>"),l=$("<ul>",{class:"list-group"});if(e.short?n.append($("<p>",{class:"lead",text:a.pdx_id+": "+e.short_title})):(n.append($("<p>",{class:"h5",text:a.pdx_id+": "+a.entry_name})),n.append($("<p>",{class:"font-weight-light text-muted",html:a.description+"<br />-"+a.entry_metadata.user}))),l.appendTo(n),a.entry_data.forEach(function(n,i){const o=$("<li>",{class:"list-group-item"});e.edit?o.append(r({label:n.key,value:n.value,func:e.edit_func,id:a._id,key:"entry_data."+i,rand_wait:t})):o.append($("<strong>",{html:n.key})).append($("<span>&emsp;"+n.value+"</span>")),e.special_list.forEach(function(t,a){t.label===n.key&&(e.special_list[a].disabled=!0)}),l.append(o)}),e.edit){let n=$("<li>",{class:"list-group-item"});l.append(n),n.append($("<button>",{class:"btn btn-primary",text:"Add Field",click:function(l){l.preventDefault();let i={},o=function(e,t){return i[e]=t,i},c=$("<li>",{class:"list-group-item"}),d=$("<div>",{class:"col-12",style:"margin-top: 10px;"});e.special_list.push({label:"Other"}),c.append(function(e){const t=s();let a=$("<div>",{class:"from-group col-"+e.width}).append($("<label>",{for:"select-header-"+t,text:e.label})),n=$("<select>",{class:"form-control",id:"select-header-"+t}),l=$("<option>",{disabled:"disabled",selected:"selected",text:"Select One"});return n.append(l),e.data.forEach(function(t){n.append($("<option>",{value:JSON.stringify({key:e.key,value:t.label}),text:t.label,disabled:t.disabled||!1}))}),a.append(n),n.change(function(t){t.preventDefault(),e.change(JSON.parse(t.target.value))}),a}({width:12,label:"Key",data:e.special_list,key:"push:entry_data",change:function(n){"Other"===n.value&&d.append(r({label:"New Key",value:"",func:function(t){t.value=o("key",t.value),e.edit_func(t)},id:a._id,key:"entry_data."+a.entry_data.length,rand_wait:t})).append(r({label:"New Value",value:"",func:function(t){t.value=o("value",t.value),e.edit_func(t)},id:a._id,key:"entry_data."+a.entry_data.length,rand_wait:t})),console.log("on change",{id:a._id,key:n.key,value:n.value,origin:"",temp:n})}})),c.append(d),n.replaceWith(c)}}))}return n}},u=function(e,t,a){const n=s(),l=$("<div>",{class:"card"});l.append(function(e,t,a){const n=a>1?" entries)":" entry)";return $("<div>",{class:"card-header",id:"header-"+t}).append($("<h2>",{class:"mb-0"}).append($("<button>",{class:"btn btn-link collapsed",type:"button","data-toggle":"collapse","data-target":"#collapse-"+t,"aria-expanded":"false","aria-controls":"collapse-"+t,html:e+" ("+a+n})))}(t,n,e.length));return function(e,t){let a,n;return a=$("<div>",{id:"collapse-"+e,class:"collapse","aria-labelledby":"headingOne","data-parent":"#accordionHolder"}),n=$("<div>",{class:"card-body"}).append(t),a.append(n),a}(n,e.map(function(e){return a.build(e,function(e){return p()(e)})})).appendTo(l),l},f=function(e){return p({short:!0,short_title:"Circle: "+e.circle})({pdx_id:e.name,entry_data:[{key:"*note",value:"This is a dummy node, it will only update after editing its child node and refreshing the timeline display."},{key:"New Exp#",value:e.name}]})};o=function(){const e=function(){let e,t,a,n,l=s(),i={};return $("#page-body").append($('<div class="modal fade" id="modal'+l+'" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="title'+l+'"></h5><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body" id="body'+l+'"></div><div class="modal-footer" id="foot'+l+'"></div></div></div></div>')),n=$("#modal"+l),e=$("#title"+l),t=$("#body"+l),a=$("#foot"+l),i.title=function(t){e.empty(),e.append(t)},i.body=function(e){t.empty(),t.append(e)},i.foot=function(e){a.empty(),a.append(e)},i.show=function(){n.modal("show")},i.hide=function(){n.modal("hide")},i}();return o=function(){return e},e};const m=function(t,n){return function(d){t.clearUpdates(),a.empty();const r=n(d),m=t.expandIDs(r);console.log("search results?",r),m.list("pdx_id").forEach(function(n){const d=m.expandIDs(m.filter(function(e){return e.pdx_id===n}));$("<p>",{class:"h3 row",text:"PDX ID: "+n}).appendTo(a);const r={nanostring:d.filter(e=>e.entry_name.match(/^PDX_ID\ to\ Nanostring\ naming\ and\ model\ information$/i)),omics:d.filter(e=>e.entry_name.match(/^PDX_ID\ to\ old\ PDX_ID_OldKinomic\/Affy\/Illumina\ ID\'s$/i))};(r.nanostring.length||r.omics.length)&&($("<p>",{class:"h4 row",text:"Avaliable Data"}).appendTo(a),function(e,t){const a=$("<p>",{class:"row"});return e.nanostring.forEach(function(e){t.build(e,function(e){let t={};return e.entry_data.forEach(function(e){t[e.key]=e.value}),$("<div>").append($("<dt>",{class:"col-sm-3",text:"NanoString"})).append($("<dd>",{class:"col-sm-9",text:t.Model+" ("+t["Comment 1"]+"): "+t.Nsname_model+" ("+t["Class Name"]+")"})).children()}).appendTo(a)}),e.omics.forEach(function(e){t.build(e,function(e){let t={};const a=$("<div>");return e.entry_data.forEach(function(e){t[e.key]=e.value}),a.append($("<dt>",{class:"col-sm-3",text:"Kinomics"})).append($("<dd>",{class:"col-sm-9",html:"<a href=http://toolbox.kinomecore.com/?data="+encodeURIComponent('*[http://db.kinomecore.com/1.0.0/lvl_1.1.2?find={"sample_data":{"$elemMatch":{"value":"'+t["Kinomics_Sample name ()"]+'"}}}]*')+">"+t["Kinomics_Sample name ()"]+"</a>"})),a.append($("<dt>",{class:"col-sm-3",text:"Affymetrix"})).append($("<dd>",{class:"col-sm-9",text:t["Affy_Sample ID"]})),a.append($("<dt>",{class:"col-sm-3",text:"Illumina"})).append($("<dd>",{class:"col-sm-9",html:t.Illumina_ID+"("+t.Illumina_SentrixPosition+")"})),a.children()}).appendTo(a)}),a}(r,t).appendTo(a));const h=d.filter(e=>e.entry_name.match(/^PDX\ Passage\ Info$/i));if(h.length){console.log(h);let n="figure-"+s();$("<p>",{class:"h4 row",text:"Passage Timeline"}).appendTo(a);let d=$("<div>",{class:"col-12"}),r=$("<div>",{class:"col-12"}),u=$("<div>",{id:n,class:"chart"}),m={};r.append(u),$("<p>",{class:"row"}).append(r).append(d).appendTo(a),t.build(h,function(a){u.empty();let s=function(e,t,a){return function(n){a.name=n.name,t.hide(),t.empty();let s=$("<div>",{class:"row"}).appendTo(t),d=$("<div>",{class:"chart-data"}).appendTo($("<div>",{class:"col col-md-4 col-sm-12"}).appendTo(s)).append($("<p>",{class:"text-center h4",text:"Prior"})),r=$("<div>",{class:"chart-data col-md-4 col-sm-12"}).appendTo(s).append($("<p>",{class:"text-center h4",text:"Selected"})),u=$("<div>",{class:"chart-data"}).appendTo($("<div>",{class:"col col-md-4 col-sm-12"}).appendTo(s)).append($("<p>",{class:"text-center h4",text:"Next"}));n.prior.forEach(function(t){t.id?d.append(e.build(t.id,p({short:!0,short_title:"Circle: "+t.circle}))):d.append(f(t))}),n.self.forEach(function(t){if(t.id){if(i.passages.write){const a=$("<button>",{class:"btn btn-primary",text:"Update",click:function(a){a.preventDefault(),function(e,t){let a={},n={};const i=o();i.title($("<h4>",{text:"Edit Entry"})),i.body(t.build(e,p({edit:!0,edit_func:function(e){a[e.id]=a[e.id]||{},a[e.id][e.key]=e},special_list:l.passages}),n)),n.clear(),i.foot($("<button>",{class:"btn btn-primary",text:"Submit",click:function(e){e.preventDefault(),console.log(a),t.set(Object.keys(a).map(e=>Object.keys(a[e]).map(t=>a[e][t])).flat().filter(e=>e.value!==e.origin)).then(function(e){return new Promise(function(t){setTimeout(t,e)})}(750)).catch(c).then(i.hide)}})),i.show()}(t.id,e)}});r.append($("<p>",{class:"text-center"}).append(a))}r.append(e.build(t.id,p({short:!0,short_title:"Circle: "+t.circle})))}else r.append(f(t))}),n.next.forEach(function(t){t.id?u.append(e.build(t.id,p({short:!0,short_title:"Circle: "+t.circle}))):u.append(f(t))}),t.show()}}(t,d,m);const r=e.createPassageFigure(a,s,m);return m.name&&(m.state&&m.state.name?s(m.state):d.hide()),loadchart(n,r.figure),u})}a.append($("<p>",{class:"h4 row",text:"All Descriptive Data"}));const y=$("<div>",{class:"accordion",id:"accordionHolder"}).appendTo($("<p>",{class:"row"}).appendTo(a));d.list("entry_name").forEach(function(e){u(d.filter(function(t){return t.entry_name===e}),e,t).appendTo(y)})})}};e.build_page=function(){const a=function(e,t){let a,n;return a=1*e.replace(/[^0-9]+/gi,""),n=1*t.replace(/[^0-9]+/gi,""),a&&n&&a>2&&n>2&&a-n!=0?a-n:e>t?1:t>e?-1:0},n=function(e){return function(t){const a=JSON.parse(t);return e.filter(function(e){return e&&e[a.key]&&e[a.key]===a.value})}},l=function(){let e={};return function(t){if(t=t.toString(),e[t])throw"Cannot call make_selectors with the same key multiple times";return e[t]={select:function(a){return e[t].select=function(n){Object.keys(e).forEach(function(a){a!==t&&e[a].unselect()}),a(n.target.value)},e[t].select},unselect:function(a){return e[t].unselect=a,e[t].unselect}},e[t]}}();return function(o,c){i=c;const r=e.expandData(o),p=[{data:r.list("pdx_id"),key:"pdx_id",label:"PDX ID",width:3,selector:l("0"),change:m(r,n(r))},{data:r.list("origin_id"),key:"origin_id",label:"Origin ID",width:3,selector:l("1"),change:m(r,n(r))}],u=$("<div>",{class:"row",id:"form-body"}).appendTo($("<div>",{class:"col-12"}).appendTo($("<div>",{class:"row"})).appendTo(t));return p.forEach(function(e){u.append(function(e){const t=s();let n=$("<div>",{class:"from-group col-"+e.width}).append($("<label>",{for:"select-header-"+t,text:e.label})),l=$("<select>",{class:"form-control",id:"select-header-"+t}),i=$("<option>",{disabled:"disabled",selected:"selected",text:"Select One"});return l.append(i),e.data.sort(a).forEach(function(t){l.append($("<option>",{value:JSON.stringify({key:e.key,value:t}),text:t}))}),n.append(l),l.change(e.selector.select(e.change)),e.selector.unselect(function(){i[0].selected=!0}),n}(e))}),function(e){const t=s(),a=e.selector.select(e.change);let n=$("<div>",{class:"form-group col-"+e.width}).append($("<label>",{for:"search-bar-"+t,text:e.label})),l=$("<input>",{class:"form-control",type:"text",id:"search-bar-"+t}),i="";return n.append(l),l.on("keyup",d(function(e){i!==e.target.value&&(a(e),i=e.target.value)},500,"search-"+t)),e.selector.unselect(function(){l.val("")}),n}({selector:l("2"),label:"Exact Word Search",width:6,change:m(r,function(e){return function(t){return e.search(t)}}(r))}).appendTo(u),p}}()}(DATA_DISPLAY);